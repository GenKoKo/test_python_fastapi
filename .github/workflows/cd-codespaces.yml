name: CD - Deploy to GitHub Codespaces

on:
    push:
        branches: [main, master]
        paths:
            - "src/**"
            - "requirements/**"
            - "Dockerfile"
            - "docker/**"
            - ".devcontainer/**"
    workflow_dispatch:
        inputs:
            force_rebuild:
                description: "Force rebuild of Codespaces prebuilds"
                required: false
                default: false
                type: boolean

permissions:
    contents: write
    packages: write
    actions: write
    codespaces: write

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # æ§‹å»º Codespaces å°ˆç”¨é¡åƒ
    build-codespaces-image:
        runs-on: ubuntu-latest
        name: Build Codespaces Image

        permissions:
            contents: read
            packages: write

        outputs:
            image-digest: ${{ steps.build.outputs.digest }}
            image-tag: ${{ steps.meta.outputs.tags }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for Codespaces
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch,suffix=-codespaces
                      type=sha,prefix=codespaces-{{branch}}-
                      type=raw,value=codespaces-latest,enable={{is_default_branch}}

            - name: Build and push Codespaces image
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: development
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha,scope=codespaces
                  cache-to: type=gha,mode=max,scope=codespaces
                  build-args: |
                      CODESPACES=true
                      INSTALL_DEV_TOOLS=true

    # æ›´æ–° Codespaces é…ç½®
    update-codespaces-config:
        runs-on: ubuntu-latest
        name: Update Codespaces Configuration
        needs: build-codespaces-image
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Update devcontainer.json with new image
              run: |
                  # æ›´æ–° devcontainer.json ä¸­çš„é¡åƒå¼•ç”¨
                  IMAGE_TAG=$(echo "${{ needs.build-codespaces-image.outputs.image-tag }}" | head -n 1)
                  echo "Updating devcontainer.json with image: $IMAGE_TAG"

                  # å‰µå»ºè‡¨æ™‚çš„ devcontainer.json æ›´æ–°
                  cat > .devcontainer/devcontainer.codespaces.json << EOF
                  {
                    "name": "FastAPI Development Environment (Auto-deployed)",
                    "image": "$IMAGE_TAG",
                    "workspaceFolder": "/app",
                    "settings": {
                      "python.defaultInterpreterPath": "/usr/local/bin/python",
                      "python.linting.enabled": true,
                      "python.linting.flake8Enabled": true,
                      "python.formatting.provider": "black",
                      "editor.formatOnSave": true
                    },
                    "extensions": [
                      "ms-python.python",
                      "ms-python.flake8",
                      "ms-python.black-formatter",
                      "ms-vscode.vscode-json",
                      "redhat.vscode-yaml",
                      "ms-vscode.docker",
                      "GitHub.copilot",
                      "humao.rest-client"
                    ],
                    "forwardPorts": [8000, 5678],
                    "portsAttributes": {
                      "8000": {
                        "label": "FastAPI Application",
                        "onAutoForward": "openBrowser",
                        "protocol": "http"
                      }
                    },
                    "postCreateCommand": "just codespaces-setup",
                    "postStartCommand": "echo 'ğŸš€ FastAPI Codespaces environment ready!'",
                    "remoteUser": "root",
                    "features": {
                      "ghcr.io/devcontainers/features/common-utils:2": {
                        "installZsh": true,
                        "configureZshAsDefaultShell": true
                      },
                      "ghcr.io/devcontainers/features/github-cli:1": {
                        "version": "latest"
                      }
                    }
                  }
                  EOF

            - name: Create Codespaces deployment info
              run: |
                  cat > .devcontainer/DEPLOYMENT_INFO.md << EOF
                  # ğŸš€ Codespaces è‡ªå‹•éƒ¨ç½²ä¿¡æ¯

                  ## éƒ¨ç½²è©³æƒ…
                  - **éƒ¨ç½²æ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  - **Git Commit**: ${{ github.sha }}
                  - **åˆ†æ”¯**: ${{ github.ref_name }}
                  - **é¡åƒ**: ${{ needs.build-codespaces-image.outputs.image-tag }}
                  - **å·¥ä½œæµç¨‹**: ${{ github.run_id }}

                  ## å¿«é€Ÿé–‹å§‹
                  \`\`\`bash
                  # å•Ÿå‹•æ‡‰ç”¨
                  just dev

                  # é‹è¡Œæ¸¬è©¦
                  just test-unit

                  # æŸ¥çœ‹ API æ–‡æª”
                  # è¨ªå•: http://localhost:8000/docs
                  \`\`\`

                  ## è‡ªå‹•éƒ¨ç½²ç‹€æ…‹
                  âœ… é¡åƒæ§‹å»ºå®Œæˆ
                  âœ… Codespaces é…ç½®æ›´æ–°
                  âœ… é–‹ç™¼ç’°å¢ƒå°±ç·’
                  EOF

    # è§¸ç™¼ Codespaces Prebuild
    trigger-prebuild:
        runs-on: ubuntu-latest
        name: Trigger Codespaces Prebuild
        needs: [build-codespaces-image, update-codespaces-config]
        if: github.event.inputs.force_rebuild == 'true' || contains(github.event.head_commit.message, '[prebuild]')
        permissions:
            actions: write
            contents: read
            codespaces: write

        steps:
            - name: Trigger Codespaces Prebuild
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      try {
                        // è§¸ç™¼ Codespaces prebuild
                        const response = await github.rest.codespaces.createOrUpdateRepoSecret({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          secret_name: 'CODESPACES_PREBUILD_TRIGGER',
                          encrypted_value: Buffer.from(new Date().toISOString()).toString('base64')
                        });
                        
                        console.log('âœ… Codespaces prebuild triggered successfully');
                      } catch (error) {
                        console.log('âš ï¸ Could not trigger prebuild automatically:', error.message);
                        console.log('ğŸ’¡ Prebuild will be triggered on next Codespaces creation');
                      }

    # éƒ¨ç½²é©—è­‰
    verify-deployment:
        runs-on: ubuntu-latest
        name: Verify Codespaces Deployment
        needs: [build-codespaces-image, update-codespaces-config]
        permissions:
            contents: read
            packages: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Test Docker image
              run: |
                  echo "ğŸ§ª Testing the built Codespaces image..."

                  # æ‹‰å–å‰›æ§‹å»ºçš„é¡åƒ
                  docker pull ${{ needs.build-codespaces-image.outputs.image-tag }}

                  # æ¸¬è©¦é¡åƒæ˜¯å¦èƒ½æ­£å¸¸å•Ÿå‹•
                  docker run --rm -d --name test-container \
                    -p 8000:8000 \
                    ${{ needs.build-codespaces-image.outputs.image-tag }} \
                    tail -f /dev/null

                  # ç­‰å¾…å®¹å™¨å•Ÿå‹•
                  sleep 5

                  # æ¸¬è©¦ Python ç’°å¢ƒ
                  docker exec test-container python --version
                  docker exec test-container pip list

                  # æ¸¬è©¦ Just å‘½ä»¤
                  docker exec test-container just --version || echo "Just not installed, will be installed in postCreateCommand"

                  # æ¸¬è©¦æ‡‰ç”¨å°å…¥
                  docker exec test-container python -c "from src.app.main import app; print('âœ… FastAPI app import successful')"

                  # æ¸…ç†
                  docker stop test-container

                  echo "âœ… Codespaces image verification completed"

    # å‰µå»ºéƒ¨ç½²å ±å‘Š
    create-deployment-report:
        runs-on: ubuntu-latest
        name: Create Deployment Report
        needs:
            [
                build-codespaces-image,
                update-codespaces-config,
                verify-deployment,
            ]
        if: always()

        steps:
            - name: Create deployment summary
              run: |
                  echo "# ğŸš€ Codespaces éƒ¨ç½²å ±å‘Š" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## éƒ¨ç½²ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.build-codespaces-image.result }}" == "success" ]; then
                    echo "âœ… **é¡åƒæ§‹å»º**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **é¡åƒæ§‹å»º**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ "${{ needs.update-codespaces-config.result }}" == "success" ]; then
                    echo "âœ… **é…ç½®æ›´æ–°**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **é…ç½®æ›´æ–°**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ "${{ needs.verify-deployment.result }}" == "success" ]; then
                    echo "âœ… **éƒ¨ç½²é©—è­‰**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **éƒ¨ç½²é©—è­‰**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## éƒ¨ç½²ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
                  echo "- **é¡åƒ**: \`${{ needs.build-codespaces-image.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **å·¥ä½œæµç¨‹**: [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ğŸ¯ å¦‚ä½•ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
                  echo "1. å‰å¾€ [GitHub Codespaces](${{ github.server_url }}/${{ github.repository }}/codespaces)" >> $GITHUB_STEP_SUMMARY
                  echo "2. å‰µå»ºæ–°çš„ Codespace æˆ–é‡å•Ÿç¾æœ‰çš„ Codespace" >> $GITHUB_STEP_SUMMARY
                  echo "3. ç­‰å¾…ç’°å¢ƒè‡ªå‹•é…ç½®å®Œæˆ" >> $GITHUB_STEP_SUMMARY
                  echo "4. é‹è¡Œ \`just dev\` å•Ÿå‹•é–‹ç™¼æœå‹™å™¨" >> $GITHUB_STEP_SUMMARY
                  echo "5. è¨ªå• http://localhost:8000/docs æŸ¥çœ‹ API æ–‡æª”" >> $GITHUB_STEP_SUMMARY

            - name: Notify deployment status
              run: |
                  if [ "${{ needs.build-codespaces-image.result }}" == "success" ] && [ "${{ needs.verify-deployment.result }}" == "success" ]; then
                    echo "ğŸ‰ Codespaces éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
                    echo "ğŸ“ æ–°çš„é–‹ç™¼ç’°å¢ƒå·²æº–å‚™å°±ç·’"
                  else
                    echo "âš ï¸ Codespaces éƒ¨ç½²é‡åˆ°å•é¡Œ"
                    echo "ğŸ” è«‹æª¢æŸ¥ä¸Šè¿°æ­¥é©Ÿçš„è©³ç´°æ—¥èªŒ"
                    exit 1
                  fi
