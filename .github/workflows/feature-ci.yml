name: Feature Branch CI

on:
    push:
        branches: ["feature/*", "bugfix/*", "hotfix/*", "feat/*", "bug/*"]

jobs:
    # 快速代碼品質檢查
    quick-check:
        runs-on: ubuntu-latest
        name: Quick Quality Check

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install uv
              uses: astral-sh/setup-uv@v4
              with:
                  version: "latest"

            - name: Install dependencies
              run: |
                  uv sync --dev

            - name: Code formatting check (Black)
              run: |
                  uv run black --check --diff src/ tests/ scripts/

            - name: Quick lint check
              run: |
                  uv run flake8 src/ tests/ scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics

            - name: Fast unit tests
              run: |
                  uv run pytest tests/ -v --tb=short -x

    # 基本構建測試（僅在重要變更時）
    build-check:
        runs-on: ubuntu-latest
        name: Build Verification
        needs: quick-check
        if: contains(github.event.head_commit.message, '[build]') || contains(github.event.head_commit.message, '[docker]')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (no push)
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: development
                  push: false
                  tags: fastapi-feature:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # 通知結果
    notify:
        runs-on: ubuntu-latest
        name: Notify Results
        needs: [quick-check]
        if: always()

        steps:
            - name: Notify success
              if: ${{ needs.quick-check.result == 'success' }}
              run: |
                  echo "✅ Feature branch checks passed!"

            - name: Notify failure
              if: ${{ needs.quick-check.result == 'failure' }}
              run: |
                  echo "❌ Feature branch checks failed!"
                  echo "💡 Fix issues before creating PR"
                  exit 1
